# å…ç™»å½•ç”¨æˆ·ç³»ç»Ÿ - æ›´æ–°è¯´æ˜

## ğŸ“‹ æ›´æ–°æ¦‚è§ˆ

æœ¬æ¬¡æ›´æ–°æˆåŠŸä¸ºè¯­éŸ³åŠ©æ‰‹ç³»ç»Ÿæ·»åŠ äº†åŸºäºè®¾å¤‡æŒ‡çº¹çš„å…ç™»å½•ç”¨æˆ·è¯†åˆ«ç³»ç»Ÿã€‚ç°åœ¨æ¯ä¸ªç”¨æˆ·çš„æ•°æ®éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”ä¼šæŒä¹…åŒ–åˆ° SQLite æ•°æ®åº“ä¸­ã€‚

## âœ¨ ä¸»è¦å˜æ›´

### 1. æ–°å¢æ–‡ä»¶

#### æ ¸å¿ƒæ¨¡å—
- **`app/database.py`** - SQLite æ•°æ®åº“ç®¡ç†æ¨¡å—
  - åˆ›å»ºå’Œç®¡ç†4ä¸ªæ•°æ®è¡¨ï¼šanonymous_users, transactions, collections, user_preferences
  - æä¾›å®Œæ•´çš„CRUDæ“ä½œ
  - è‡ªåŠ¨ä»æ—§çš„JSONå­˜å‚¨è¿ç§»æ•°æ®
  - åŒ…å«ç”¨æˆ·ç»Ÿè®¡å’Œæ•°æ®æ¸…ç†åŠŸèƒ½

- **`app/device_fingerprint.py`** - è®¾å¤‡æŒ‡çº¹ç”Ÿæˆæ¨¡å—
  - åŸºäº User-Agent, Accept-Language, IP ç­‰ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
  - ç”Ÿæˆå”¯ä¸€çš„ device_id (æ ¼å¼: device_{fingerprint}_{random_salt})
  - æä¾›æŒ‡çº¹éªŒè¯å’Œè§£æåŠŸèƒ½
  - ç®€å•çš„ User-Agent è§£æ

- **`app/user_session.py`** - ç”¨æˆ·ä¼šè¯ç®¡ç†æ¨¡å—
  - ç®¡ç†åŒ¿åç”¨æˆ·çš„åˆ›å»ºã€æ›´æ–°å’ŒæŸ¥è¯¢
  - Cookie è‡ªåŠ¨è®¾ç½®å’Œç®¡ç†ï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰
  - ç”¨æˆ·åå¥½è®¾ç½®ç®¡ç†
  - ç”¨æˆ·è¡Œä¸ºè¿½è¸ª

- **`app/middleware.py`** - ä¸­é—´ä»¶æ¨¡å—
  - è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·ï¼ˆä»Cookieæˆ–ç”Ÿæˆæ–°IDï¼‰
  - ä¸ºæ¯ä¸ªè¯·æ±‚æ³¨å…¥ device_id åˆ° request.state
  - ç®€å•çš„é¢‘ç‡é™åˆ¶åŠŸèƒ½
  - æä¾›è¾…åŠ©å‡½æ•°ï¼šget_current_user(), get_current_device_id()

#### æ–‡æ¡£
- **`å…ç™»å½•ç³»ç»Ÿä½¿ç”¨è¯´æ˜.md`** - è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£
- **`æ›´æ–°è¯´æ˜.md`** - æœ¬æ–‡ä»¶ï¼Œæ›´æ–°æ€»ç»“

### 2. ä¿®æ”¹æ–‡ä»¶

#### `app/storage.py`
- **é‡å¤§å˜æ›´**ï¼šä» JSON å­˜å‚¨è¿ç§»åˆ° SQLite
- æ‰€æœ‰æ–¹æ³•ç°åœ¨éƒ½éœ€è¦ `device_id` å‚æ•°æ¥å®ç°å¤šç”¨æˆ·æ•°æ®éš”ç¦»
- æ·»åŠ è‡ªåŠ¨æ•°æ®è¿ç§»åŠŸèƒ½ï¼ˆä» JSON åˆ° SQLiteï¼‰
- ä¸»è¦æ–¹æ³•å˜æ›´ï¼š
  - `add_entity(device_id, entity_name)` - æ·»åŠ ç”¨æˆ·å‚æ•°
  - `get_entities(device_id)` - è·å–ç‰¹å®šç”¨æˆ·çš„entities
  - `add_transaction(device_id, transaction)` - ä¸ºç‰¹å®šç”¨æˆ·æ·»åŠ äº¤æ˜“
  - `get_statistics(device_id, ...)` - è·å–ç‰¹å®šç”¨æˆ·çš„ç»Ÿè®¡æ•°æ®
  - æ‰€æœ‰å…¶ä»–æ–¹æ³•åŒæ ·æ·»åŠ äº† device_id å‚æ•°

#### `app/server.py`
- æ·»åŠ ç”¨æˆ·è¯†åˆ«ä¸­é—´ä»¶
- æ‰€æœ‰ API ç«¯ç‚¹é›†æˆç”¨æˆ·ç³»ç»Ÿ
- ä¸»è¦å˜æ›´ï¼š
  - ä» `request.state` è·å– device_id
  - æ‰€æœ‰ä¸šåŠ¡é€»è¾‘è°ƒç”¨éƒ½ä¼ é€’ device_id
  - æ–°å¢ç”¨æˆ·ç›¸å…³APIç«¯ç‚¹ï¼ˆè§ä¸‹æ–‡ï¼‰
- æ–°å¢ API ç«¯ç‚¹ï¼š
  - `GET /api/user/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  - `POST /api/user/track` - è¿½è¸ªç”¨æˆ·è¡Œä¸º
  - `GET/POST /api/user/preferences` - ç®¡ç†ç”¨æˆ·åå¥½
  - `GET /api/analytics/dashboard` - è·å–ç”¨æˆ·ç»Ÿè®¡

#### `app/agent.py`
- æ‰€æœ‰å¤„ç†æ–¹æ³•æ·»åŠ  `device_id` å‚æ•°
- ä¸»è¦å˜æ›´ï¼š
  - `process_message(message, device_id, history, lang)` - æ·»åŠ  device_id
  - `get_welcome_message(device_id, lang)` - ä¸ªæ€§åŒ–æ¬¢è¿æ¶ˆæ¯
  - æ‰€æœ‰ handler æ–¹æ³•ï¼ˆ`_handle_*`ï¼‰éƒ½æ·»åŠ äº† device_id å‚æ•°
  - è°ƒç”¨ storage æ—¶ä¼ é€’ device_id

#### `chat-ui.html`
- æ‰€æœ‰ API è¯·æ±‚æ·»åŠ  `credentials: 'include'` ä»¥æ”¯æŒ Cookie
- æ–°å¢ `getCurrentUser()` å‡½æ•°åœ¨åˆå§‹åŒ–æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
- ä¸»è¦å˜æ›´ï¼š
  - æ‰€æœ‰ fetch è¯·æ±‚æ·»åŠ  `credentials: 'include'`
  - åˆå§‹åŒ–æ—¶è°ƒç”¨ `/api/user/me`
  - æ·»åŠ  `currentUser` å…¨å±€å˜é‡å­˜å‚¨ç”¨æˆ·ä¿¡æ¯

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

### anonymous_users
```sql
CREATE TABLE anonymous_users (
    device_id TEXT PRIMARY KEY,
    fingerprint TEXT NOT NULL,
    user_data TEXT,
    created_at INTEGER NOT NULL,
    last_seen INTEGER NOT NULL,
    session_count INTEGER DEFAULT 1
)
```

### transactions
```sql
CREATE TABLE transactions (
    id TEXT PRIMARY KEY,
    device_id TEXT NOT NULL,
    entity TEXT NOT NULL,
    transaction_type TEXT NOT NULL,
    amount REAL NOT NULL,
    description TEXT,
    timestamp INTEGER NOT NULL,
    FOREIGN KEY (device_id) REFERENCES anonymous_users (device_id)
)
```

### collections
```sql
CREATE TABLE collections (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    device_id TEXT NOT NULL,
    entity_name TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (device_id) REFERENCES anonymous_users (device_id)
)
```

### user_preferences
```sql
CREATE TABLE user_preferences (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    device_id TEXT NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (device_id) REFERENCES anonymous_users (device_id)
)
```

## ğŸ”„ æ•°æ®è¿ç§»

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹ `data/transactions.json` å¹¶è¿ç§»æ•°æ®ï¼š
1. æ‰€æœ‰æ—§æ•°æ®åˆ†é…åˆ°ç‰¹æ®Šç”¨æˆ·ï¼š`device_legacy_0000000000000000`
2. è¿ç§»å®Œæˆååˆ›å»º `.migrated` æ ‡è®°æ–‡ä»¶
3. åŸå§‹ JSON æ–‡ä»¶ä¿ç•™ä¸åˆ é™¤

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### å¯åŠ¨æœåŠ¡
```bash
# ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
cd /Users/ericren/projects/chat/voice-assistant

# å¯åŠ¨æœåŠ¡ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ï¼‰
uvicorn app.server:app --reload
```

### è®¿é—®åº”ç”¨
1. æ‰“å¼€æµè§ˆå™¨è®¿é—® `file:///Users/ericren/projects/chat/voice-assistant/chat-ui.html`
2. æˆ–è®¿é—® API æ–‡æ¡£ï¼š`http://localhost:8000/docs`

### æµ‹è¯•å¤šç”¨æˆ·
1. åœ¨ Chrome æ­£å¸¸æ¨¡å¼ä¸‹è®¿é—®åº”ç”¨ï¼Œæ·»åŠ ä¸€äº›æ•°æ®
2. åœ¨ Chrome éšèº«æ¨¡å¼ä¸‹è®¿é—®åº”ç”¨ï¼Œä¼šçœ‹åˆ°ç©ºç™½çŠ¶æ€
3. åœ¨ä¸¤ä¸ªæ¨¡å¼ä¸­åˆ†åˆ«æ·»åŠ ä¸åŒçš„ collections
4. åˆ·æ–°é¡µé¢ï¼Œæ•°æ®ä¿æŒç‹¬ç«‹

### æŸ¥çœ‹æ•°æ®åº“
```bash
# ä½¿ç”¨ SQLite å‘½ä»¤è¡Œ
sqlite3 data/users.db

# æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
SELECT device_id, created_at, last_seen, session_count FROM anonymous_users;

# æŸ¥çœ‹æŸç”¨æˆ·çš„æ•°æ®
SELECT * FROM collections WHERE device_id = 'device_xxx';
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

1. **Cookie ä¾èµ–**
   - ç³»ç»Ÿä¾èµ– Cookie è¯†åˆ«ç”¨æˆ·
   - ç¡®ä¿æµè§ˆå™¨å…è®¸ Cookie
   - å‰ç«¯å¿…é¡»åœ¨è¯·æ±‚ä¸­åŒ…å« `credentials: 'include'`

2. **æ•°æ®æŒä¹…åŒ–**
   - æ‰€æœ‰æ•°æ®ç°åœ¨å­˜å‚¨åœ¨ SQLite (`data/users.db`)
   - åˆ é™¤æ­¤æ–‡ä»¶ä¼šä¸¢å¤±æ‰€æœ‰ç”¨æˆ·æ•°æ®
   - å»ºè®®å®šæœŸå¤‡ä»½æ•°æ®åº“æ–‡ä»¶

3. **æ€§èƒ½è€ƒè™‘**
   - SQLite é€‚åˆä¸­å°è§„æ¨¡åº”ç”¨
   - å¤§è§„æ¨¡åº”ç”¨å»ºè®®è¿ç§»åˆ° PostgreSQL
   - è€ƒè™‘æ·»åŠ  Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®

4. **éšç§å’Œå®‰å…¨**
   - ä¸æ”¶é›†å¯è¯†åˆ«ä¸ªäººä¿¡æ¯
   - IPåœ°å€ä»…ç”¨äºç”ŸæˆæŒ‡çº¹ï¼Œä¸å­˜å‚¨
   - Cookie è®¾ç½®äº†å®‰å…¨æ ‡å¿—ï¼ˆhttpOnly, samesiteï¼‰

## ğŸ“Š API å˜æ›´æ€»ç»“

### æ–°å¢ API
- `GET /api/user/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `POST /api/user/track` - è¿½è¸ªç”¨æˆ·è¡Œä¸º
- `GET /api/user/preferences` - è·å–ç”¨æˆ·åå¥½
- `POST /api/user/preferences` - æ›´æ–°ç”¨æˆ·åå¥½
- `GET /api/analytics/dashboard` - ç”¨æˆ·ç»Ÿè®¡

### ä¿®æ”¹çš„ APIï¼ˆè¡Œä¸ºå˜æ›´ï¼‰
æ‰€æœ‰ç°æœ‰ API ç°åœ¨éƒ½ä¼šï¼š
1. è‡ªåŠ¨è¯†åˆ«å½“å‰ç”¨æˆ·ï¼ˆé€šè¿‡ä¸­é—´ä»¶ï¼‰
2. åªæ“ä½œå½“å‰ç”¨æˆ·çš„æ•°æ®
3. éœ€è¦åŒ…å« Cookieï¼ˆcredentials: 'include'ï¼‰

å—å½±å“çš„ç«¯ç‚¹ï¼š
- `GET /collections` - åªè¿”å›å½“å‰ç”¨æˆ·çš„collections
- `POST /collections` - ä¸ºå½“å‰ç”¨æˆ·æ·»åŠ collection
- `DELETE /collections/{entity}` - åˆ é™¤å½“å‰ç”¨æˆ·çš„collection
- `GET /statistics` - å½“å‰ç”¨æˆ·çš„ç»Ÿè®¡æ•°æ®
- `GET /transactions/recent` - å½“å‰ç”¨æˆ·çš„äº¤æ˜“è®°å½•
- `POST /chat` - å…³è”åˆ°å½“å‰ç”¨æˆ·
- `POST /voice` - å…³è”åˆ°å½“å‰ç”¨æˆ·
- `DELETE /data/clear` - åªæ¸…é™¤å½“å‰ç”¨æˆ·çš„æ•°æ®

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **åŸºç¡€åŠŸèƒ½æµ‹è¯•**
   - é¦–æ¬¡è®¿é—®åˆ›å»ºç”¨æˆ·
   - æ·»åŠ  collections å’Œ transactions
   - åˆ·æ–°é¡µé¢éªŒè¯æ•°æ®æŒä¹…åŒ–

2. **å¤šç”¨æˆ·æµ‹è¯•**
   - ä½¿ç”¨ä¸åŒæµè§ˆå™¨/éšèº«æ¨¡å¼
   - éªŒè¯æ•°æ®å®Œå…¨éš”ç¦»
   - æµ‹è¯•å¤šä¸ªç”¨æˆ·åŒæ—¶ä½¿ç”¨

3. **Cookie æµ‹è¯•**
   - æ¸…é™¤ Cookie åé‡æ–°è®¿é—®
   - éªŒè¯æŒ‡çº¹åŒ¹é…æœºåˆ¶
   - æµ‹è¯• Cookie è¿‡æœŸæƒ…å†µ

4. **è¿ç§»æµ‹è¯•**
   - å¦‚æœæœ‰æ—§çš„ JSON æ•°æ®
   - éªŒè¯è‡ªåŠ¨è¿ç§»åŠŸèƒ½
   - æ£€æŸ¥è¿ç§»åçš„æ•°æ®å®Œæ•´æ€§

## ğŸ”® æœªæ¥è®¡åˆ’

ç³»ç»Ÿè®¾è®¡æ”¯æŒæœªæ¥å‡çº§ï¼š
- [ ] æ·»åŠ ç”¨æˆ·æ³¨å†Œ/ç™»å½•åŠŸèƒ½
- [ ] æ”¯æŒé‚®ç®±/æ‰‹æœºå·ç»‘å®š
- [ ] ç¤¾äº¤ç™»å½•é›†æˆï¼ˆå¾®ä¿¡ã€Googleï¼‰
- [ ] è¿ç§»åˆ° PostgreSQLï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] æ·»åŠ  Redis ç¼“å­˜
- [ ] å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼ˆGDPRåˆè§„ï¼‰

## ğŸ“ æ–‡ä»¶ç»“æ„

```
voice-assistant/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ database.py          # æ–°å¢ï¼šæ•°æ®åº“ç®¡ç†
â”‚   â”œâ”€â”€ device_fingerprint.py # æ–°å¢ï¼šè®¾å¤‡æŒ‡çº¹ç”Ÿæˆ
â”‚   â”œâ”€â”€ user_session.py      # æ–°å¢ï¼šä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ middleware.py        # æ–°å¢ï¼šä¸­é—´ä»¶
â”‚   â”œâ”€â”€ storage.py           # ä¿®æ”¹ï¼šå¤šç”¨æˆ·æ”¯æŒ
â”‚   â”œâ”€â”€ server.py            # ä¿®æ”¹ï¼šé›†æˆç”¨æˆ·ç³»ç»Ÿ
â”‚   â”œâ”€â”€ agent.py             # ä¿®æ”¹ï¼šæ·»åŠ device_idå‚æ•°
â”‚   â””â”€â”€ ...
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ users.db             # æ–°å¢ï¼šSQLiteæ•°æ®åº“
â”‚   â”œâ”€â”€ transactions.json    # æ—§æ–‡ä»¶ï¼Œå¯é€‰ä¿ç•™
â”‚   â””â”€â”€ .migrated            # è¿ç§»æ ‡è®°æ–‡ä»¶
â”œâ”€â”€ chat-ui.html             # ä¿®æ”¹ï¼šæ”¯æŒCookie
â”œâ”€â”€ å…ç™»å½•ç”¨æˆ·è®¾è®¡æ–‡æ¡£.md      # åŸå§‹è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ å…ç™»å½•ç³»ç»Ÿä½¿ç”¨è¯´æ˜.md      # æ–°å¢ï¼šä½¿ç”¨è¯´æ˜
â””â”€â”€ æ›´æ–°è¯´æ˜.md               # æœ¬æ–‡ä»¶
```

## âœ… å®Œæˆçš„TODO

- [x] åˆ›å»ºæ•°æ®åº“æ¨¡å— - è®¾è®¡ SQLite è¡¨ç»“æ„
- [x] åˆ›å»ºè®¾å¤‡æŒ‡çº¹ç”Ÿæˆå™¨æ¨¡å—
- [x] åˆ›å»ºç”¨æˆ·ä¼šè¯ç®¡ç†æ¨¡å—
- [x] æ·»åŠ ä¸­é—´ä»¶ - è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·å¹¶è®¾ç½® Cookie
- [x] ä¿®æ”¹ storage.py - æ”¯æŒå¤šç”¨æˆ·æ•°æ®éš”ç¦»
- [x] ä¿®æ”¹ server.py - é›†æˆç”¨æˆ·ç³»ç»Ÿåˆ°æ‰€æœ‰ API ç«¯ç‚¹
- [x] ä¿®æ”¹å‰ç«¯ - è‡ªåŠ¨å¤„ç†è®¾å¤‡è¯†åˆ«å’Œä¼šè¯ç®¡ç†
- [x] æ·»åŠ ç”¨æˆ·ç›¸å…³çš„ API ç«¯ç‚¹

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šç”¨æˆ·æ•°æ®ä¸¢å¤±
**åŸå› **ï¼šCookie è¢«æ¸…é™¤æˆ–æµè§ˆå™¨ä¸æ”¯æŒ Cookie
**è§£å†³**ï¼š
1. æ£€æŸ¥æµè§ˆå™¨ Cookie è®¾ç½®
2. ç¡®ä¿å‰ç«¯ä½¿ç”¨ `credentials: 'include'`
3. æŸ¥çœ‹è®¾å¤‡æŒ‡çº¹æ˜¯å¦èƒ½åŒ¹é…æ—§ç”¨æˆ·

### é—®é¢˜ï¼šæ•°æ®åº“é”å®šé”™è¯¯
**åŸå› **ï¼šSQLite å¹¶å‘å†™å…¥é™åˆ¶
**è§£å†³**ï¼š
1. ç¡®ä¿ä½¿ç”¨è¿æ¥æ± 
2. è€ƒè™‘è¿ç§»åˆ° PostgreSQL
3. å‡å°‘é•¿æ—¶é—´çš„æ•°æ®åº“äº‹åŠ¡

### é—®é¢˜ï¼šè¿ç§»å¤±è´¥
**åŸå› **ï¼šæ—§ JSON æ•°æ®æ ¼å¼é—®é¢˜
**è§£å†³**ï¼š
1. æ£€æŸ¥ JSON æ–‡ä»¶æ ¼å¼
2. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
3. æ‰‹åŠ¨æ¸…ç†åé‡è¯•

---

**ç‰ˆæœ¬**: 0.2.0  
**æ›´æ–°æ—¶é—´**: 2026-01-29  
**ä½œè€…**: AI Assistant  
**åŸºäº**: å…ç™»å½•ç”¨æˆ·è®¾è®¡æ–‡æ¡£.md
