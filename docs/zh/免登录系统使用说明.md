# 免登录用户系统使用说明

## 系统概述

该系统已成功集成基于设备指纹的免登录用户识别系统。用户无需注册登录，系统会自动识别和追踪每个用户，所有数据都存储在 SQLite 数据库中。

## 主要特性

### 1. 自动用户识别
- **设备指纹**：基于 User-Agent、语言、IP等生成唯一设备指纹
- **Cookie管理**：自动设置和管理 device_id cookie（30天有效期）
- **会话追踪**：记录用户访问次数和最后访问时间

### 2. 多用户数据隔离
- 每个用户的collections（追踪的物品）完全独立
- 每个用户的transactions（交易记录）完全独立
- 用户偏好设置独立存储

### 3. 数据持久化
- 使用 SQLite 数据库存储所有数据
- 用户每次打开网站都能看到自己的数据
- 支持从旧的 JSON 存储自动迁移

## 数据库结构

### anonymous_users 表
存储匿名用户基本信息：
- `device_id`: 设备唯一标识（主键）
- `fingerprint`: 设备指纹
- `user_data`: JSON格式的额外用户数据
- `created_at`: 创建时间
- `last_seen`: 最后访问时间
- `session_count`: 访问次数

### transactions 表
存储交易记录：
- `id`: 交易ID
- `device_id`: 所属用户
- `entity`: 物品名称
- `transaction_type`: 交易类型（consumed/received）
- `amount`: 数量
- `description`: 描述
- `timestamp`: 时间戳

### collections 表
存储用户追踪的物品：
- `id`: 自增ID
- `device_id`: 所属用户
- `entity_name`: 物品名称
- `created_at`: 创建时间

### user_preferences 表
存储用户偏好设置：
- `id`: 自增ID
- `device_id`: 所属用户
- `key`: 偏好设置键
- `value`: 偏好设置值（JSON格式）
- `updated_at`: 更新时间

## API 端点

### 用户相关

#### GET /api/user/me
获取当前用户信息
```json
{
  "success": true,
  "device_id": "device_abc123_xyz789",
  "is_authenticated": false,
  "user_type": "anonymous",
  "created_at": 1234567890,
  "session_count": 5
}
```

#### POST /api/user/track
追踪用户行为
```bash
POST /api/user/track?action=page_view
Content-Type: application/json

{
  "data": {
    "url": "/home",
    "referrer": "https://google.com"
  }
}
```

#### POST /api/user/preferences
更新用户偏好
```bash
POST /api/user/preferences
Content-Type: application/json

{
  "theme": "dark",
  "language": "zh-CN"
}
```

#### GET /api/user/preferences
获取用户所有偏好设置

#### GET /api/analytics/dashboard
获取用户统计数据（管理员用）

### 业务相关

所有现有的API端点都已自动集成用户系统：
- `GET /collections` - 获取当前用户的collections
- `POST /collections` - 为当前用户添加collection
- `DELETE /collections/{entity}` - 删除当前用户的collection
- `GET /statistics` - 获取当前用户的统计数据
- `GET /transactions/recent` - 获取当前用户的最近交易
- `POST /chat` - 聊天（自动关联到当前用户）
- `DELETE /data/clear` - 清除当前用户的数据

## 前端集成

### Cookie 处理
前端需要在所有 API 请求中包含 `credentials: 'include'` 以发送 Cookie：

```javascript
fetch(`${API_BASE_URL}/collections`, {
    credentials: 'include'
})
```

### 用户初始化
页面加载时自动调用 `/api/user/me` 获取用户信息：

```javascript
async function getCurrentUser() {
    const response = await fetch(`${API_BASE_URL}/api/user/me`, {
        credentials: 'include'
    });
    const currentUser = await response.json();
}
```

## 工作流程

### 首次访问
1. 用户打开网站
2. 中间件检测无 cookie，生成设备指纹
3. 创建新用户记录并设置 cookie
4. 用户开始使用，所有数据关联到该 device_id

### 再次访问
1. 用户打开网站
2. 中间件读取 cookie 中的 device_id
3. 从数据库加载用户数据
4. 更新 last_seen 和 session_count
5. 用户看到之前的数据

### Cookie 丢失
1. 用户清除了 cookie
2. 中间件重新生成设备指纹
3. 如果指纹匹配旧用户，恢复之前的 device_id
4. 如果指纹不匹配，创建新用户

## 数据迁移

系统会自动检测旧的 JSON 存储文件（`data/transactions.json`）并迁移数据：
- 所有旧数据会被分配到特殊的 `device_legacy_0000000000000000` 用户
- 迁移完成后创建 `.migrated` 标记文件
- 不会删除原始 JSON 文件

## 安全和隐私

### 隐私保护
- 不收集可识别个人信息
- IP地址仅用于生成指纹，不长期存储
- Cookie 设置 httpOnly 防止 XSS
- Cookie 设置 samesite="lax" 防止 CSRF

### 数据清理
系统提供 API 清理长期不活跃的用户：
```python
from app.database import get_database

db = get_database()
deleted_count = db.cleanup_old_users(days=30)  # 清理30天未访问的用户
```

## 启动服务

```bash
# 安装依赖（如果还没安装）
pip install -r requirements.txt

# 启动服务
uvicorn app.server:app --reload

# 访问
# API: http://localhost:8000
# 文档: http://localhost:8000/docs
# 前端: 打开 chat-ui.html
```

## 测试

### 测试多用户
1. 在浏览器1中访问应用，添加一些数据
2. 在浏览器2（或隐身模式）中访问应用
3. 两个浏览器看到不同的数据（完全独立）
4. 关闭并重新打开浏览器1，数据依然存在

### 查看用户数据
```bash
# 使用 SQLite 命令行查看数据库
sqlite3 data/users.db

# 查看所有用户
SELECT device_id, created_at, last_seen, session_count FROM anonymous_users;

# 查看特定用户的collections
SELECT * FROM collections WHERE device_id = 'device_xxx';

# 查看特定用户的transactions
SELECT * FROM transactions WHERE device_id = 'device_xxx';
```

## 未来扩展

系统设计支持未来升级到完整的登录系统：
- 阶段1：纯匿名系统（当前）✅
- 阶段2：添加手机号/邮箱绑定选项
- 阶段3：支持社交登录（微信、Google）
- 阶段4：完整账户系统
- 阶段5：多因素认证

迁移路径：
```python
def migrate_anonymous_to_user(device_id, user_id):
    """将匿名用户数据迁移到正式用户账号"""
    # 1. 复制用户偏好设置
    # 2. 迁移行为历史
    # 3. 更新所有关联数据的外键
    # 4. 标记匿名记录为已迁移
```

## 故障排查

### 用户无法被识别
- 检查浏览器是否允许 Cookie
- 检查 CORS 设置是否正确
- 查看浏览器控制台是否有错误

### 数据没有持久化
- 检查 SQLite 数据库文件是否存在（`data/users.db`）
- 查看服务器日志是否有数据库错误
- 确认中间件正确安装

### 性能问题
- 添加数据库索引（已自动创建）
- 考虑使用 Redis 缓存热点数据
- 定期清理长期不活跃的用户数据

## 技术栈

- **后端**: FastAPI + Python 3.8+
- **数据库**: SQLite（开发）/ PostgreSQL（生产可选）
- **中间件**: 自定义用户识别中间件
- **前端**: HTML5 + JavaScript（原生）

---

更新时间：2026-01-29
版本：0.2.0
